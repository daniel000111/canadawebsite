<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BTE Canada - Admin Upload</title>
  <link rel="icon" href="assets/logo-square.png" type="image/png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="admin-body">
  <!-- NAVBAR -->
  <header class="nav-wrap">
    <nav class="nav">
      <div class="nav-left fade-in fade-delay-1">
        <a href="index.html" class="brand">
          <img src="assets/logo-square.gif" alt="BTE Canada Logo" class="nav-logo" />
          <span class="brand-text">BTE CANADA</span>
        </a>
      </div>

      <div class="nav-center fade-in fade-delay-2">
        <a href="index.html">Home</a>
        <a href="showcase.html">Showcase</a>
        <a href="visit.html">Visit</a>
        <a href="build.html">Build</a>
        <a href="docs.html">Docs</a>
        <a href="map.html">Map</a>
      </div>

          <div class="nav-right fade-in fade-delay-3">
      <a class="icon-btn" href="https://discord.gg/pnPSvpfhAs" target="_blank" aria-label="Discord">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M20.317 4.369a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.211.375-.444.864-.608 1.249a18.27 18.27 0 0 0-5.487 0c-.164-.385-.397-.874-.608-1.249a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.683 4.37a.07.07 0 0 0-.032.027C.533 9.045-.32 13.58.099 18.057a.082.082 0 0 0 .031.056 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.461-.63.873-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128c.126-.094.252-.192.371-.291a.074.074 0 0 1 .077-.01c3.927 1.793 8.18 1.793 12.061 0a.074.074 0 0 1 .078.01c.12.099.245.197.372.291a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.106c.36.699.772 1.364 1.225 1.994a.076.076 0 0 0 .084.028 19.9 19.9 0 0 0 5.994-3.03.077.077 0 0 0 .03-.056c.5-5.177-.838-9.673-3.548-13.66a.061.061 0 0 0-.031-.03z"/>
        </svg>
      </a>
      <a class="icon-btn" href="https://www.instagram.com/bte.canada/" target="_blank" aria-label="Instagram">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M7 2C4.243 2 2 4.243 2 7v10c0 2.757 2.243 5 5 5h10c2.757 0 5-2.243 5-5V7c0-2.757-2.243-5-5-5H7zm10 2a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h10zm-5 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm4.75-.75a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/>
        </svg>
      </a>
      <a class="icon-btn" href="https://www.tiktok.com/@btecanada" target="_blank" aria-label="TikTok">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M16.5 3a5.5 5.5 0 0 0 4 1.8V8a8.4 8.4 0 0 1-4-1.1v6.6a6.5 6.5 0 1 1-6.5-6.5c.3 0 .6 0 .9.1V10a3.5 3.5 0 1 0 2.6 3.4V3h3z"/>
        </svg>
      </a>
      <div class="settings-wrap">
        <button class="settings-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-label="Open settings" onclick="toggleSettingsMenu(event)">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M19.14 12.94a7.94 7.94 0 0 0 .05-.94 7.94 7.94 0 0 0-.05-.94l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.6 7.6 0 0 0-1.63-.94l-.36-2.54a.5.5 0 0 0-.5-.42h-3.84a.5.5 0 0 0-.5.42l-.36 2.54c-.58.22-1.12.52-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.75 8.86a.5.5 0 0 0 .12.64l2.03 1.58c-.03.31-.05.63-.05.94s.02.63.05.94l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32a.5.5 0 0 0 .6.22l2.39-.96c.5.42 1.05.72 1.63.94l.36 2.54a.5.5 0 0 0 .5.42h3.84a.5.5 0 0 0 .5-.42l.36-2.54c.58-.22 1.12-.52 1.63-.94l2.39.96a.5.5 0 0 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8a3.5 3.5 0 0 1 0 7.5z"></path>
          </svg>
        </button>
        <div class="settings-menu" aria-hidden="true">
          <div class="settings-profile" id="settingsProfile" style="display:none;">
            <img id="settingsAvatar" class="admin-avatar settings-avatar" alt="" />
            <span id="settingsName" class="settings-name"></span>
          </div>
          <button class="theme-btn ghost" type="button" onclick="toggleTheme()" aria-label="Toggle theme">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M21 14.5A8.5 8.5 0 1 1 9.5 3a7 7 0 0 0 11.5 11.5z"></path>
            </svg>
            <span class="theme-label">Light</span>
          </button>
          <a class="cta-btn admin-btn" id="adminLink" href="login.html">Login</a>
          <button class="cta-btn logout-btn" id="logoutBtnMenu" type="button">Log out</button>
        </div>
      </div>
    </div>
  </nav>
  </header>

  <main class="admin-page">
    <section class="docs-card admin-gate" id="adminGate">
      <h2>Admin Access Required</h2>
      <p class="section-text">This account hasn't been authorized to access the panel.</p>
      <a class="cta-btn admin-btn" href="login.html">Retry Login</a>
      <p class="docs-note" id="adminGateStatus"></p>
    </section>

    <div id="adminContent" style="display:none;">
      <section class="admin-hero-panel">
        <div class="admin-card">
          <div class="admin-card-header">
            <img id="adminAvatarHero" class="admin-avatar admin-avatar-lg" alt="" style="display:none;" />
            <div>
              <h1 id="welcomeText">Welcome, Builder!</h1>
              <p class="section-text">You can edit site settings here.</p>
            </div>
          </div>
          <div class="admin-actions">
            <button class="cta-btn admin-action" type="button" data-modal-target="screenshotModal" data-min-role="staff">Screenshot Manager</button>
            <button class="cta-btn ghost admin-action" type="button" data-modal-target="announcementModal" data-min-role="staff">Edit Announcement</button>
            <button class="cta-btn ghost admin-action" type="button" data-modal-target="builderAreasModal" data-min-role="staff">Edit Builder Areas</button>
            <a class="cta-btn ghost admin-action" href="#" aria-disabled="true" data-min-role="developer">Docs Editor (coming soon)</a>
            <button class="cta-btn ghost admin-action" type="button" data-modal-target="staffManagerModal" data-min-role="admin">Staff Manager</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="admin-modal" id="screenshotModal" aria-hidden="true">
    <div class="admin-modal-card" role="dialog" aria-modal="true" aria-labelledby="screenshotModalTitle">
      <div class="admin-modal-header">
        <h2 id="screenshotModalTitle">Screenshot Manager</h2>
        <button class="admin-modal-close" type="button" data-modal-close>Close</button>
      </div>

      <section class="docs-card" id="admin-upload">
        <h2>Screenshot Uploader</h2>
        <p class="section-text">Upload a screenshot and add the details.</p>

        <form id="uploadForm" class="docs-form">
          <input type="file" id="imageFile" accept="image/*" required />
          <input type="text" id="placeInput" placeholder="Place name" required />
          <input type="text" id="provInput" placeholder="Province (e.g. ON)" />
          <input type="text" id="buildersInput" placeholder="Builders (comma separated)" />
          <input type="text" id="folderInput" placeholder="Optional folder (e.g. toronto)" />
          <button class="cta-btn" type="submit">Upload</button>
        </form>

        <div class="admin-preview">
          <img id="imagePreview" alt="Preview" />
          <div class="admin-progress">
            <progress id="uploadProgress" max="100" value="0"></progress>
            <span id="uploadProgressText">0%</span>
          </div>
        </div>

        <p class="docs-note" id="uploadStatus"></p>
      </section>

      <section class="docs-card admin-list-card" id="admin-manage">
        <div class="admin-list-header">
          <div>
            <h2>Manage Screenshots</h2>
            <p class="section-text">Edit details or delete uploads.</p>
          </div>
          <input type="search" id="adminSearch" class="admin-search" placeholder="Search by place or province..." />
        </div>
        <div id="adminList" class="admin-list"></div>
      </section>
    </div>
  </div>

  <div class="admin-modal" id="announcementModal" aria-hidden="true">
    <div class="admin-modal-card" role="dialog" aria-modal="true" aria-labelledby="announcementModalTitle">
      <div class="admin-modal-header">
        <h2 id="announcementModalTitle">Edit Announcement</h2>
        <button class="admin-modal-close" type="button" data-modal-close>Close</button>
      </div>
      <section class="docs-card admin-announcement-card">
        <p class="section-text">Set a short message that appears in the navbar.</p>
        <div class="docs-form admin-announcement-form">
          <textarea id="announcementInput" rows="4" placeholder="Enter announcement..."></textarea>
          <div class="admin-announcement-actions">
            <button class="cta-btn admin-btn" id="announcementSave" type="button">Update Announcement</button>
            <button class="cta-btn ghost" id="announcementClear" type="button">Clear Announcement</button>
          </div>
        </div>
        <p class="docs-note" id="announcementStatus"></p>
      </section>
    </div>
  </div>

  <div class="admin-modal" id="builderAreasModal" aria-hidden="true">
    <div class="admin-modal-card" role="dialog" aria-modal="true" aria-labelledby="builderAreasModalTitle">
      <div class="admin-modal-header">
        <h2 id="builderAreasModalTitle">Edit Builder Areas</h2>
        <button class="admin-modal-close" type="button" data-modal-close>Close</button>
      </div>
      <section class="docs-card admin-announcement-card">
        <p class="section-text">Update the current event and focus areas shown in the builder panel.</p>
        <div class="docs-form admin-announcement-form">
          <h3 class="admin-section-title">Event Area</h3>
          <input type="text" id="eventAreaInput" placeholder="Event area (e.g. Moncton, NB)" />
          <input type="text" id="eventWarpInput" placeholder="Event warp command (e.g. /warp event)" />
          <input type="text" id="eventImageInput" placeholder="Event image URL (optional)" />
          <div class="admin-focus-upload">
            <input type="file" id="eventImageFile" accept="image/*" />
            <button class="cta-btn ghost" id="eventImageUpload" type="button">Upload Event Image</button>
          </div>
          <h3 class="admin-section-title">Focus Areas</h3>
          <div class="admin-focus-list" id="focusAreasList"></div>
          <button class="cta-btn ghost" id="focusAddBtn" type="button">Add Focus Area</button>
          <div class="admin-announcement-actions">
            <button class="cta-btn admin-btn" id="builderAreasSave" type="button">Update Builder Areas</button>
          </div>
        </div>
        <p class="docs-note" id="builderAreasStatus"></p>
      </section>
    </div>
  </div>

  <div class="admin-modal" id="staffManagerModal" aria-hidden="true">
    <div class="admin-modal-card" role="dialog" aria-modal="true" aria-labelledby="staffManagerModalTitle">
      <div class="admin-modal-header">
        <h2 id="staffManagerModalTitle">Staff Manager</h2>
        <button class="admin-modal-close" type="button" data-modal-close>Close</button>
      </div>
      <section class="admin-hero-panel">
        <div class="admin-card staff-manager-card">
          <div class="admin-card-header">
            <h3>Add Staff Member</h3>
            <p class="section-text">Add members and set permission levels.</p>
          </div>

          <form id="staffAddForm" class="docs-form staff-form">
            <input type="text" id="staffMcInput" placeholder="Minecraft username" required />
            <input type="text" id="staffDiscordInput" placeholder="Discord ID" required />
            <input type="text" id="staffTitleInput" placeholder="Official title (e.g. Team Owner)" />
            <select id="staffRoleInput" required>
              <option value="None">None</option>
              <option value="Staff">Staff</option>
              <option value="Developer">Developer</option>
              <option value="Admin">Admin</option>
            </select>
            <label class="staff-checkbox">
              <input type="checkbox" id="staffShowInput" />
              <span>Show on front page</span>
            </label>
            <button class="cta-btn admin-btn" type="submit">Add User</button>
          </form>

          <p class="docs-note" id="staffStatus"></p>

          <div class="staff-list" id="staffList"></div>
        </div>
      </section>
    </div>
  </div>

  <footer class="footer">
    2026 BTE Canada Â· Not affiliated with Mojang
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="script.js"></script>
  <script>
  (function () {
    const supabaseConfig = window.APP_SUPABASE || {};
    const ADMIN_SUPABASE_URL = supabaseConfig.url;
    const ADMIN_SUPABASE_ANON_KEY = supabaseConfig.key;
    const sbClient = window.APP_SUPABASE_CLIENT || window.supabase.createClient(ADMIN_SUPABASE_URL, ADMIN_SUPABASE_ANON_KEY);
    const SUPABASE_BUCKET = "screenshots";
    const BUILDER_AREAS_BUCKET = "builder-areas";

    const ALLOWED_DISCORD_IDS = [
      "617699025973542930",
      "451804972728975371",
      "808025660425371718",
      "292688678789054465",
      "440983805487218698"
    ];

    const gate = document.getElementById("adminGate");
    const gateStatus = document.getElementById("adminGateStatus");
    const content = document.getElementById("adminContent");
    const form = document.getElementById("uploadForm");
    const status = document.getElementById("uploadStatus");
    const welcomeText = document.getElementById("welcomeText");
    const logoutBtn = document.getElementById("logoutBtn");
    const preview = document.getElementById("imagePreview");
    const progress = document.getElementById("uploadProgress");
    const progressText = document.getElementById("uploadProgressText");
    const listEl = document.getElementById("adminList");
    const searchInput = document.getElementById("adminSearch");
    const staffForm = document.getElementById("staffAddForm");
    const staffStatus = document.getElementById("staffStatus");
    const staffListEl = document.getElementById("staffList");
    const staffModal = document.getElementById("staffManagerModal");
    const builderModal = document.getElementById("builderAreasModal");
    const eventAreaInput = document.getElementById("eventAreaInput");
    const eventWarpInput = document.getElementById("eventWarpInput");
    const eventImageInput = document.getElementById("eventImageInput");
    const eventImageFile = document.getElementById("eventImageFile");
    const eventImageUpload = document.getElementById("eventImageUpload");
    const focusAreasList = document.getElementById("focusAreasList");
    const focusAddBtn = document.getElementById("focusAddBtn");
    const builderAreasSave = document.getElementById("builderAreasSave");
    const builderAreasStatus = document.getElementById("builderAreasStatus");

    function initAdminModals() {
      const openers = document.querySelectorAll("[data-modal-target]");
      const closers = document.querySelectorAll("[data-modal-close]");

      openers.forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-modal-target");
          const modal = document.getElementById(id);
          if (!modal) return;
          modal.classList.add("show");
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
          if (modal === staffModal) {
            loadStaffList();
          }
          if (modal === builderModal) {
            loadBuilderAreas();
          }
        });
      });

      function closeModal(modal) {
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      }

      closers.forEach((btn) => {
        btn.addEventListener("click", () => {
          const modal = btn.closest(".admin-modal");
          if (modal) closeModal(modal);
        });
      });

      document.querySelectorAll(".admin-modal").forEach((modal) => {
        modal.addEventListener("click", (event) => {
          if (event.target === modal) closeModal(modal);
        });
      });

      document.addEventListener("keydown", (event) => {
        if (event.key !== "Escape") return;
        const modal = document.querySelector(".admin-modal.show");
        if (modal) closeModal(modal);
      });
    }

    async function fetchStaffRole(discordId) {
      if (!discordId) return null;
      try {
        const { data } = await sbClient
          .from("staff_members")
          .select("role")
          .eq("discord_id", discordId)
          .maybeSingle();
        return data?.role || null;
      } catch (err) {
        return null;
      }
    }

    function applyRoleAccess(role) {
      const roleRank = {
        none: 0,
        staff: 1,
        developer: 2,
        admin: 3
      };
      const currentRank = roleRank[(role || "none").toLowerCase()] ?? 0;
      document.querySelectorAll("[data-min-role]").forEach((el) => {
        const required = el.getAttribute("data-min-role") || "none";
        const requiredRank = roleRank[required.toLowerCase()] ?? 0;
        const allowed = currentRank >= requiredRank;
        if (el.tagName === "A") {
          el.setAttribute("aria-disabled", allowed ? "false" : "true");
          el.classList.toggle("is-disabled", !allowed);
          if (!allowed) {
            el.setAttribute("tabindex", "-1");
          } else {
            el.removeAttribute("tabindex");
          }
        } else {
          el.disabled = !allowed;
          el.classList.toggle("is-disabled", !allowed);
        }
      });
    }

    async function fetchDiscordProfile(discordId) {
      try {
        const { data, error } = await sbClient.functions.invoke("discord-profile", {
          body: { discord_id: discordId }
        });
        if (!error) return data || null;

        const status = error?.context?.status || error?.status || "";
        const msg = error?.message || error?.context?.body || String(error);
        if (staffStatus) staffStatus.textContent = `Discord lookup failed (${status}): ${msg}`;
        console.error("Discord lookup failed via invoke:", error);
      } catch (err) {
        if (staffStatus) staffStatus.textContent = `Discord lookup failed: ${err.message || err}`;
        console.error("Discord lookup failed via invoke:", err);
      }

      try {
        const fnUrl = `${supabaseConfig.url}/functions/v1/discord-profile`;
        const res = await fetch(fnUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${supabaseConfig.key}`,
            apikey: supabaseConfig.key
          },
          body: JSON.stringify({ discord_id: discordId })
        });
        if (!res.ok) {
          const text = await res.text();
          if (staffStatus) staffStatus.textContent = `Discord lookup failed (${res.status}): ${text}`;
          return null;
        }
        return await res.json();
      } catch (err) {
        if (staffStatus) staffStatus.textContent = `Discord lookup failed: ${err.message || err}`;
        return null;
      }
    }

    async function loadStaffList() {
      if (!staffListEl) return;
      const { data, error } = await sbClient
        .from("staff_members")
        .select("id,mc_username,discord_id,discord_username,official_title,role,show_on_front,avatar_url")
        .order("mc_username", { ascending: true });
      if (error) {
        if (staffStatus) staffStatus.textContent = `Failed to load staff: ${error.message}`;
        return;
      }
      renderStaffList(data || []);
    }

    function createFocusRow(item = {}) {
      if (!focusAreasList) return;
      const row = document.createElement("div");
      row.className = "admin-focus-row";
      row.innerHTML = `
        <input type="text" placeholder="Area (e.g. Toronto)" data-focus-field="area" />
        <input type="text" placeholder="/warp command" data-focus-field="warp" />
        <input type="text" placeholder="Image URL (optional)" data-focus-field="image" />
        <input type="file" accept="image/*" data-focus-field="file" />
        <button class="cta-btn ghost" type="button" data-focus-upload>Upload</button>
        <button class="cta-btn ghost" type="button" data-focus-remove>Remove</button>
      `;
      row.querySelector('[data-focus-field="area"]').value = item.area || "";
      row.querySelector('[data-focus-field="warp"]').value = item.warp || "";
      row.querySelector('[data-focus-field="image"]').value = item.image || "";

      row.querySelector("[data-focus-upload]").addEventListener("click", async () => {
        const fileInput = row.querySelector('[data-focus-field="file"]');
        const file = fileInput?.files?.[0];
        if (!file) {
          if (builderAreasStatus) builderAreasStatus.textContent = "Select an image file first.";
          return;
        }
        const url = await uploadBuilderImage(file, "builder-focus");
        if (url) {
          row.querySelector('[data-focus-field="image"]').value = url;
          if (builderAreasStatus) builderAreasStatus.textContent = "Image uploaded.";
        }
      });

      row.querySelector("[data-focus-remove]").addEventListener("click", () => {
        row.remove();
      });
      focusAreasList.appendChild(row);
    }

    function getFocusAreasFromRows() {
      if (!focusAreasList) return [];
      const rows = Array.from(focusAreasList.querySelectorAll(".admin-focus-row"));
      return rows
        .map((row) => {
          const area = row.querySelector('[data-focus-field="area"]').value.trim();
          const warp = row.querySelector('[data-focus-field="warp"]').value.trim();
          const image = row.querySelector('[data-focus-field="image"]').value.trim();
          return { area, warp, image };
        })
        .filter((item) => item.area || item.warp || item.image);
    }

    async function loadBuilderAreas() {
      if (!eventAreaInput || !eventWarpInput || !focusAreasList) return;
      if (builderAreasStatus) builderAreasStatus.textContent = "Loading...";
      const { data, error } = await sbClient
        .from("builder_areas")
        .select("event_area,event_warp,event_image,focus_areas")
        .eq("id", 1)
        .maybeSingle();
      if (error) {
        if (builderAreasStatus) builderAreasStatus.textContent = `Failed to load: ${error.message}`;
        return;
      }
      eventAreaInput.value = data?.event_area || "";
      eventWarpInput.value = data?.event_warp || "";
      eventImageInput.value = data?.event_image || "";
      focusAreasList.innerHTML = "";
      const focusItems = Array.isArray(data?.focus_areas) ? data.focus_areas : [];
      if (focusItems.length) {
        focusItems.forEach((item) => createFocusRow(item || {}));
      } else {
        createFocusRow();
      }
      if (builderAreasStatus) builderAreasStatus.textContent = "";
    }

    async function uploadBuilderImage(file, folder) {
      const { data } = await sbClient.auth.getSession();
      const accessToken = data.session?.access_token;
      if (!accessToken) {
        if (builderAreasStatus) builderAreasStatus.textContent = "Session expired. Please log in again.";
        return "";
      }

      const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
      const prefix = folder ? `${folder.replace(/[^a-zA-Z0-9/_-]/g, "")}/` : "";
      const path = `${prefix}${Date.now()}_${safeName}`;

      try {
        await uploadWithProgress(file, `${BUILDER_AREAS_BUCKET}/${path}`, accessToken);
      } catch (err) {
        if (builderAreasStatus) builderAreasStatus.textContent = `Upload failed: ${err.message}`;
        return "";
      }

      return `${ADMIN_SUPABASE_URL}/storage/v1/object/public/${BUILDER_AREAS_BUCKET}/${path}`;
    }

    function renderStaffList(rows) {
      if (!staffListEl) return;
      staffListEl.innerHTML = "";
      if (!rows.length) {
        staffListEl.innerHTML = "<p class=\"section-text\">No staff added yet.</p>";
        return;
      }
      rows.forEach((row) => {
        const card = document.createElement("div");
        card.className = "staff-item";
        card.innerHTML = `
          <div class="staff-item-grid">
            <input type="text" value="${row.mc_username || ""}" data-field="mc_username" />
            <input type="text" value="${row.discord_id || ""}" data-field="discord_id" />
            <input type="text" value="${row.discord_username || ""}" data-field="discord_username" placeholder="Discord username" readonly />
            <input type="text" value="${row.avatar_url || ""}" data-field="avatar_url" placeholder="Avatar URL" readonly />
            <input type="text" value="${row.official_title || ""}" data-field="official_title" placeholder="Official title" />
            <select data-field="role">
              <option value="None">None</option>
              <option value="Staff">Staff</option>
              <option value="Developer">Developer</option>
              <option value="Admin">Admin</option>
            </select>
            <label class="staff-checkbox inline">
              <input type="checkbox" data-field="show_on_front" ${row.show_on_front ? "checked" : ""} />
              <span>Show</span>
            </label>
          </div>
          <div class="admin-item-actions">
            <button class="cta-btn admin-save" type="button">Save</button>
            <button class="cta-btn ghost admin-refresh" type="button">Refresh Profile</button>
            <button class="cta-btn ghost admin-delete" type="button">Delete</button>
          </div>
        `;
        const roleSelect = card.querySelector("[data-field=\"role\"]");
        roleSelect.value = row.role || "None";

        card.querySelector(".admin-save").addEventListener("click", async () => {
          const mc_username = card.querySelector("[data-field=\"mc_username\"]").value.trim();
          const discord_id = card.querySelector("[data-field=\"discord_id\"]").value.trim();
          const avatar_url_field = card.querySelector("[data-field=\"avatar_url\"]");
          const discord_username_field = card.querySelector("[data-field=\"discord_username\"]");
          const official_title = card.querySelector("[data-field=\"official_title\"]").value.trim();
          const role = card.querySelector("[data-field=\"role\"]").value;
          const show_on_front = card.querySelector("[data-field=\"show_on_front\"]").checked;

          let avatar_url = avatar_url_field?.value?.trim() || "";
          let discord_username = discord_username_field?.value?.trim() || "";

          if (discord_id && (!discord_username || !avatar_url)) {
            const profile = await fetchDiscordProfile(discord_id);
            if (profile?.avatar_url) avatar_url = profile.avatar_url;
            if (profile?.username) discord_username = profile.username;
          }

          const { error: updateError } = await sbClient
            .from("staff_members")
            .update({ mc_username, discord_id, discord_username, avatar_url, official_title, role, show_on_front })
            .eq("id", row.id);

          if (updateError) {
            staffStatus.textContent = `Update failed: ${updateError.message}`;
          } else {
            staffStatus.textContent = "Updated successfully.";
          }
        });

        card.querySelector(".admin-refresh").addEventListener("click", async () => {
          const discord_id = card.querySelector("[data-field=\"discord_id\"]").value.trim();
          if (!discord_id) {
            staffStatus.textContent = "Add a Discord ID before refreshing.";
            return;
          }
          staffStatus.textContent = "Refreshing Discord profile...";
          const profile = await fetchDiscordProfile(discord_id);
          const nextAvatar = profile?.avatar_url || "";
          const nextUsername = profile?.username || "";
          card.querySelector("[data-field=\"avatar_url\"]").value = nextAvatar;
          card.querySelector("[data-field=\"discord_username\"]").value = nextUsername;
          const { error: updateError } = await sbClient
            .from("staff_members")
            .update({
              discord_id,
              discord_username: nextUsername,
              avatar_url: nextAvatar
            })
            .eq("id", row.id);
          if (updateError) {
            staffStatus.textContent = `Refresh failed: ${updateError.message}`;
          } else {
            staffStatus.textContent = "Profile refreshed.";
            loadStaffList();
          }
        });

        card.querySelector(".admin-delete").addEventListener("click", async () => {
          if (!confirm("Delete this staff member?")) return;
          const { error: deleteError } = await sbClient
            .from("staff_members")
            .delete()
            .eq("id", row.id);
          if (deleteError) {
            staffStatus.textContent = `Delete failed: ${deleteError.message}`;
            return;
          }
          staffStatus.textContent = "Deleted.";
          loadStaffList();
        });

        staffListEl.appendChild(card);
      });
    }

    async function requireSession() {
      const { data } = await sbClient.auth.getSession();
      if (!data.session) {
        if (gate) gate.hidden = false;
        if (content) content.style.display = "none";
        window.location.href = "login.html";
        return null;
      }
      const discordIdentity = data.session.user?.identities?.find((i) => i.provider === "discord");
      const discordId = data.session.user?.user_metadata?.provider_id
        || data.session.user?.user_metadata?.sub
        || discordIdentity?.id
        || "";
      const username = data.session.user?.user_metadata?.full_name
        || data.session.user?.user_metadata?.name
        || data.session.user?.user_metadata?.preferred_username
        || data.session.user?.email
        || "Builder";
      const staffRole = await fetchStaffRole(discordId);
      const isAdminAllowlist = ALLOWED_DISCORD_IDS.length && ALLOWED_DISCORD_IDS.includes(discordId);
      const resolvedRole = isAdminAllowlist ? "Admin" : (staffRole || "None");

      if (!isAdminAllowlist && (!staffRole || staffRole === "None")) {
        if (gate) gate.hidden = false;
        if (gateStatus) gateStatus.textContent = "Not authorized. Please contact an admin for access.";
        if (content) content.style.display = "none";
        form.querySelectorAll("input,button").forEach((el) => (el.disabled = true));
        return null;
      }
      if (gate) gate.hidden = true;
      if (content) content.style.display = "";
      if (welcomeText) {
        welcomeText.textContent = `Welcome, ${username}!`;
      }
      applyRoleAccess(resolvedRole);
      const avatarUrl = resolveDiscordAvatar(data.session.user);
      if (avatarUrl) {
        const avatarHero = document.getElementById("adminAvatarHero");
        if (avatarHero) {
          avatarHero.src = avatarUrl;
          avatarHero.alt = `${username} avatar`;
          avatarHero.style.display = "block";
        }
      }
      return data.session;
    }

  async function uploadWithProgress(file, path, accessToken) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      const safePath = path.split("/").map(encodeURIComponent).join("/");
      xhr.open("POST", `${ADMIN_SUPABASE_URL}/storage/v1/object/${SUPABASE_BUCKET}/${safePath}`);
      xhr.setRequestHeader("Authorization", `Bearer ${accessToken}`);
      xhr.setRequestHeader("apikey", ADMIN_SUPABASE_ANON_KEY);
      xhr.setRequestHeader("x-upsert", "false");

      xhr.upload.onprogress = (e) => {
        if (!e.lengthComputable) return;
        const pct = Math.round((e.loaded / e.total) * 100);
        progress.value = pct;
        progressText.textContent = `${pct}%`;
      };

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          resolve();
        } else {
          reject(new Error(xhr.responseText || "Upload failed"));
        }
      };

      xhr.onerror = () => reject(new Error("Network error"));
      xhr.send(file);
    });
  }

    let ADMIN_ROWS = [];

    function renderAdminList(rows) {
      listEl.innerHTML = "";
      if (!rows.length) {
        listEl.innerHTML = `<p class="section-text">No screenshots match your search.</p>`;
        return;
      }

      rows.forEach((row) => {
        const card = document.createElement("div");
        card.className = "admin-item";
        const imgUrl = `${ADMIN_SUPABASE_URL}/storage/v1/object/public/${SUPABASE_BUCKET}/${row.image_path}`;
        const builders = Array.isArray(row.builders) ? row.builders.join(", ") : "";

        card.innerHTML = `
          <img src="${imgUrl}" alt="${row.place || "Screenshot"}" />
          <div class="admin-item-body">
            <input type="text" value="${row.place || ""}" data-field="place" />
            <input type="text" value="${row.prov || ""}" data-field="prov" />
            <input type="text" value="${builders}" data-field="builders" />
            <div class="admin-item-actions">
              <button class="cta-btn admin-save" type="button">Save</button>
              <button class="cta-btn ghost admin-delete" type="button">Delete</button>
            </div>
          </div>
        `;

        card.querySelector(".admin-save").addEventListener("click", async () => {
          const place = card.querySelector("[data-field=\"place\"]").value.trim();
          const prov = card.querySelector("[data-field=\"prov\"]").value.trim();
          const buildersRaw = card.querySelector("[data-field=\"builders\"]").value.trim();
          const buildersList = buildersRaw ? buildersRaw.split(",").map(s => s.trim()).filter(Boolean) : [];

          const { error: updateError } = await sbClient
            .from("screenshots")
            .update({ place, prov, builders: buildersList })
            .eq("id", row.id);

          if (updateError) {
            status.textContent = `Update failed: ${updateError.message}`;
          } else {
            status.textContent = "Updated successfully!";
            row.place = place;
            row.prov = prov;
            row.builders = buildersList;
          }
        });

        card.querySelector(".admin-delete").addEventListener("click", async () => {
          if (!confirm("Delete this screenshot?")) return;
          const { error: deleteError } = await sbClient
            .from("screenshots")
            .delete()
            .eq("id", row.id);

          if (deleteError) {
            status.textContent = `Delete failed: ${deleteError.message}`;
            return;
          }

          await sbClient.storage.from(SUPABASE_BUCKET).remove([row.image_path]);
          status.textContent = "Deleted.";
          ADMIN_ROWS = ADMIN_ROWS.filter((r) => r.id !== row.id);
          renderAdminList(filterRows(searchInput?.value || ""));
        });

        listEl.appendChild(card);
      });
    }

    function filterRows(term) {
      const q = term.toLowerCase().trim();
      if (!q) return ADMIN_ROWS;
      return ADMIN_ROWS.filter((row) => {
        return (row.place || "").toLowerCase().includes(q)
          || (row.prov || "").toLowerCase().includes(q);
      });
    }

    async function loadAdminList() {
      const { data, error } = await sbClient
        .from("screenshots")
        .select("id,image_path,place,prov,builders,created_at")
        .order("created_at", { ascending: false });

      if (error) {
        listEl.textContent = `Failed to load list: ${error.message}`;
        return;
      }

      ADMIN_ROWS = data || [];
      if (!ADMIN_ROWS.length) {
        listEl.innerHTML = `<p class="section-text">No screenshots yet.</p>`;
        return;
      }
      renderAdminList(ADMIN_ROWS);
    }

  document.getElementById("imageFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) {
      preview.removeAttribute("src");
      return;
    }
    preview.src = URL.createObjectURL(file);
  });

    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        await sbClient.auth.signOut();
        window.location.href = "login.html";
      });
    }

    if (searchInput) {
      searchInput.addEventListener("input", () => {
        renderAdminList(filterRows(searchInput.value));
      });
    }

    (async () => {
      const session = await requireSession();
      if (!session) return;
      await loadAdminList();
      initAdminModals();
    })();

    if (staffForm) {
      staffForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const mc_username = document.getElementById("staffMcInput").value.trim();
        const discord_id = document.getElementById("staffDiscordInput").value.trim();
        const official_title = document.getElementById("staffTitleInput").value.trim();
        const role = document.getElementById("staffRoleInput").value;
        const show_on_front = document.getElementById("staffShowInput").checked;

        if (!mc_username || !discord_id) {
          staffStatus.textContent = "Please add Minecraft username and Discord ID.";
          return;
        }
        staffStatus.textContent = "Looking up Discord profile...";
        const profile = await fetchDiscordProfile(discord_id);
        const avatar_url = profile?.avatar_url || "";
        const discord_username = profile?.username || "";
        staffStatus.textContent = "Saving...";
        const { error } = await sbClient
          .from("staff_members")
          .insert([{ mc_username, discord_id, discord_username, avatar_url, official_title, role, show_on_front }]);
        if (error) {
          staffStatus.textContent = `Save failed: ${error.message}`;
          return;
        }
        staffStatus.textContent = "User added.";
        staffForm.reset();
        loadStaffList();
      });
    }

    if (builderAreasSave) {
      builderAreasSave.addEventListener("click", async () => {
        const event_area = eventAreaInput.value.trim();
        const event_warp = eventWarpInput.value.trim();
        const event_image = eventImageInput.value.trim();
        const focus_areas = getFocusAreasFromRows();

        if (builderAreasStatus) builderAreasStatus.textContent = "Saving...";
        const { error } = await sbClient
          .from("builder_areas")
          .upsert({ id: 1, event_area, event_warp, event_image, focus_areas }, { onConflict: "id" });
        if (error) {
          if (builderAreasStatus) builderAreasStatus.textContent = `Save failed: ${error.message}`;
          return;
        }
        if (builderAreasStatus) builderAreasStatus.textContent = "Builder areas updated.";
      });
    }

    if (eventImageUpload) {
      eventImageUpload.addEventListener("click", async () => {
        const file = eventImageFile?.files?.[0];
        if (!file) {
          if (builderAreasStatus) builderAreasStatus.textContent = "Select an event image first.";
          return;
        }
        const url = await uploadBuilderImage(file, "builder-event");
        if (url) {
          eventImageInput.value = url;
          if (builderAreasStatus) builderAreasStatus.textContent = "Event image uploaded.";
        }
      });
    }

    if (focusAddBtn) {
      focusAddBtn.addEventListener("click", () => {
        createFocusRow();
      });
    }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    status.textContent = "Uploading...";
    progress.value = 0;
    progressText.textContent = "0%";

    const file = document.getElementById("imageFile").files[0];
    const place = document.getElementById("placeInput").value.trim();
    const prov = document.getElementById("provInput").value.trim();
    const buildersRaw = document.getElementById("buildersInput").value.trim();
    const folder = document.getElementById("folderInput").value.trim();

    if (!file || !place) {
      status.textContent = "Please add a file and place name.";
      return;
    }

      const { data } = await sbClient.auth.getSession();
      const accessToken = data.session?.access_token;
    if (!accessToken) {
      status.textContent = "Session expired. Please log in again.";
      return;
    }

    const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
    const prefix = folder ? `${folder.replace(/[^a-zA-Z0-9/_-]/g, "")}/` : "";
    const path = `${prefix}${Date.now()}_${safeName}`;

    try {
      await uploadWithProgress(file, path, accessToken);
    } catch (err) {
      status.textContent = `Upload failed: ${err.message}`;
      return;
    }

    const builders = buildersRaw
      ? buildersRaw.split(",").map(s => s.trim()).filter(Boolean)
      : [];

      const { error: insertError } = await sbClient
        .from("screenshots")
        .insert([{ image_path: path, place, prov, builders }]);

    if (insertError) {
      status.textContent = `Database error: ${insertError.message}`;
      return;
    }

    status.textContent = "Uploaded successfully!";
    form.reset();
    preview.removeAttribute("src");
    await loadAdminList();
  });
  })();
</script>
</body>
</html>
